# Shopping Mode Implementation Plan

## –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º "–ò–¥—É –≤ –º–∞–≥–∞–∑–∏–Ω", –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–Ω–∏—Ä—É–µ—Ç —ç—Ç–∏–∫–µ—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –∞ –∑–∞—Ç–µ–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏—Ö —Å —á–µ–∫–æ–º –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —É—á–µ—Ç–∞ –ö–ë–ñ–£ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏–π.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- [ ] **–¢–∞–±–ª–∏—Ü–∞ `ShoppingSession`**
  - `id` (PK)
  - `user_id` (FK ‚Üí users)
  - `started_at` (datetime)
  - `finished_at` (datetime, nullable)
  - `is_active` (boolean)

- [ ] **–¢–∞–±–ª–∏—Ü–∞ `LabelScan`**
  - `id` (PK)
  - `session_id` (FK ‚Üí shopping_sessions)
  - `name` (str) - –Ω–∞–∑–≤–∞–Ω–∏–µ —Å —ç—Ç–∏–∫–µ—Ç–∫–∏
  - `brand` (str, nullable)
  - `weight` (str, nullable) - –≤–µ—Å/–æ–±—ä–µ–º
  - `calories` (int, nullable) - –∫–∫–∞–ª –Ω–∞ 100–≥
  - `protein` (float, nullable) - –±–µ–ª–∫–∏ –Ω–∞ 100–≥
  - `fat` (float, nullable) - –∂–∏—Ä—ã –Ω–∞ 100–≥
  - `carbs` (float, nullable) - —É–≥–ª–µ–≤–æ–¥—ã –Ω–∞ 100–≥
  - `matched_product_id` (FK ‚Üí products, nullable) - —Å–≤—è–∑—å —Å –ø–æ–∑–∏—Ü–∏–µ–π –∏–∑ —á–µ–∫–∞
  - `created_at` (datetime)

### 2. FSM States (Aiogram)
- [ ] `ShoppingMode.scanning_labels` - —Ä–µ–∂–∏–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–∏–∫–µ—Ç–æ–∫
- [ ] `ShoppingMode.waiting_for_receipt` - –æ–∂–∏–¥–∞–Ω–∏–µ —á–µ–∫–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–∫—É–ø–æ–∫

### 3. UI/UX Flow

#### 3.1 –ù–∞—á–∞–ª–æ –ø–æ–∫—É–ø–æ–∫
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É **"üõí –ò–¥—É –≤ –º–∞–≥–∞–∑–∏–Ω"** –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (`handlers/common.py`)
- [ ] –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏:
  - –°–æ–∑–¥–∞—Ç—å `ShoppingSession` (is_active=True)
  - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å FSM state ‚Üí `ShoppingMode.scanning_labels`
  - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é: "–°–∫–∞–Ω–∏—Ä—É–π —ç—Ç–∏–∫–µ—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤. –ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—à—å, –Ω–∞–∂–º–∏ '–Ø –∑–∞–∫–æ–Ω—á–∏–ª –ø–æ–∫—É–ø–∫–∏'."

#### 3.2 –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∏–∫–µ—Ç–æ–∫
- [ ] –í —Ä–µ–∂–∏–º–µ `scanning_labels`:
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ —ç—Ç–∏–∫–µ—Ç–∫–∏
  - –ë–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç OCR (Gemini 2.0 Flash) –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:
    - –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
    - –ë—Ä–µ–Ω–¥
    - –í–µ—Å/–æ–±—ä–µ–º
    - –ö–ë–ñ–£ (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞ —ç—Ç–∏–∫–µ—Ç–∫–µ)
  - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ `LabelScan` (session_id = —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è)
  - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:
    ```
    ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É:
    üì¶ [–ù–∞–∑–≤–∞–Ω–∏–µ] [–í–µ—Å]
    üè∑Ô∏è [–ë—Ä–µ–Ω–¥]
    üî• –ö–ë–ñ–£: [–ö/–ë/–ñ/–£]
    
    [–ö–Ω–æ–ø–∫–∞: "‚úÖ –Ø –∑–∞–∫–æ–Ω—á–∏–ª –ø–æ–∫—É–ø–∫–∏"]
    ```

#### 3.3 –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ–∫—É–ø–æ–∫
- [ ] –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–Ø –∑–∞–∫–æ–Ω—á–∏–ª –ø–æ–∫—É–ø–∫–∏":
  - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å FSM state ‚Üí `ShoppingMode.waiting_for_receipt`
  - –û—Ç–ø—Ä–∞–≤–∏—Ç—å: "–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ —á–µ–∫–∞."

#### 3.4 –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–∞
- [ ] –í —Ä–µ–∂–∏–º–µ `waiting_for_receipt`:
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ —á–µ–∫–∞
  - –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —á–µ–∫ (OCR + Normalization, –∫–∞–∫ –æ–±—ã—á–Ω–æ)
  - **–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞**: —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å `LabelScan`
    - –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —á–µ–∫–∞:
      - –ù–∞–π—Ç–∏ –ø–æ—Ö–æ–∂—É—é –∑–∞–ø–∏—Å—å –≤ `LabelScan` (fuzzy matching –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é + –≤–µ—Å)
      - –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ:
        - –°–≤—è–∑–∞—Ç—å `LabelScan.matched_product_id` —Å `Product.id`
        - –û–±–Ω–æ–≤–∏—Ç—å –ö–ë–ñ–£ –≤ `Product` –∏–∑ `LabelScan`
      - –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:
        - –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ "–Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö"

#### 3.5 –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
- [ ] –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å:
  - **–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏** (–∑–µ–ª–µ–Ω–∞—è –≥–∞–ª–æ—á–∫–∞)
  - **–ù–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —á–µ–∫–∞** (–∂–µ–ª—Ç—ã–π –≤–æ–ø—Ä–æ—Å)
  - **–ù–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —ç—Ç–∏–∫–µ—Ç–∫–∏** (–∫—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç)

- [ ] –î–ª—è –∫–∞–∂–¥–æ–π –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏:
  - –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É:
    ```
    ‚ùì –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ:
    
    üìÑ –ß–µ–∫: [–ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —á–µ–∫–∞]
    üíµ [–¶–µ–Ω–∞]
    
    –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–∑ —ç—Ç–∏–∫–µ—Ç–æ–∫:
    [–ö–Ω–æ–ø–∫–∞: "üì¶ [–ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∏–∫–µ—Ç–∫–∏ 1]"]
    [–ö–Ω–æ–ø–∫–∞: "üì¶ [–ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∏–∫–µ—Ç–∫–∏ 2]"]
    [–ö–Ω–æ–ø–∫–∞: "‚ûï –≠—Ç–æ –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä"]
    ```

### 4. –ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Fuzzy Matching)
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `rapidfuzz` –∏–ª–∏ `fuzzywuzzy`
- [ ] –ö—Ä–∏—Ç–µ—Ä–∏–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è:
  - –°—Ö–æ–∂–µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è > 70%
  - –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤–µ—Å–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
  - –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)

### 5. –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è

#### –°–æ–∑–¥–∞—Ç—å:
- [ ] `FoodFlow/database/models.py` - –¥–æ–±–∞–≤–∏—Ç—å `ShoppingSession`, `LabelScan`
- [ ] `FoodFlow/handlers/shopping.py` - –ª–æ–≥–∏–∫–∞ —Ä–µ–∂–∏–º–∞ –ø–æ–∫—É–ø–æ–∫
- [ ] `FoodFlow/services/label_ocr.py` - OCR –¥–ª—è —ç—Ç–∏–∫–µ—Ç–æ–∫ (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ö–ë–ñ–£)
- [ ] `FoodFlow/services/matching.py` - –∞–ª–≥–æ—Ä–∏—Ç–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

#### –ò–∑–º–µ–Ω–∏—Ç—å:
- [ ] `FoodFlow/handlers/common.py` - –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "üõí –ò–¥—É –≤ –º–∞–≥–∞–∑–∏–Ω"
- [ ] `FoodFlow/handlers/receipt.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∂–∏–º–æ–º –ø–æ–∫—É–ø–æ–∫
- [ ] `FoodFlow/main.py` - –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ä–æ—É—Ç–µ—Ä
- [ ] `FoodFlow/requirements.txt` - –¥–æ–±–∞–≤–∏—Ç—å `rapidfuzz`

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. [x] –°–æ–∑–¥–∞—Ç—å —ç—Ç–æ—Ç –ø–ª–∞–Ω
2. [ ] –û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É –ë–î (models.py)
3. [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
4. [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å FSM –∏ handler –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–∏–∫–µ—Ç–æ–∫
5. [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å OCR –¥–ª—è —ç—Ç–∏–∫–µ—Ç–æ–∫ (KBZHU extraction)
6. [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
7. [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —á–µ–∫–∞
8. [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å UI –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
9. [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

**–°—Ç–∞—Ç—É—Å:** üöß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-20 12:47
