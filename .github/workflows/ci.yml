name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install project and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"

      - name: Run Ruff linting
        run: |
          ruff check .

      - name: Run MyPy type checking
        run: |
          mypy . --ignore-missing-imports --strict-optional --warn-unused-ignores || true

      - name: Run Bandit security check
        run: |
          bandit -r handlers/ services/ -ll -i -x tests/ || true

      - name: Check if tests directory exists
        id: check-tests
        run: |
          if [ -d "tests" ] && [ "$(ls -A tests 2>/dev/null)" ]; then
            echo "tests_exist=true" >> $GITHUB_OUTPUT
          else
            echo "tests_exist=false" >> $GITHUB_OUTPUT
          fi

      - name: Run pytest with coverage
        if: steps.check-tests.outputs.tests_exist == 'true'
        env:
          BOT_TOKEN: "test-token-ci"
          OPENROUTER_API_KEY: "test-key-ci"
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
        run: |
          pytest tests/ --cov=handlers --cov=services --cov-report=xml --cov-report=term ----cov-fail-under=80 =80 --tb=short -v

      - name: Skip pytest (no tests yet)
        if: steps.check-tests.outputs.tests_exist == 'false'
        run: |
          echo "No tests directory found. Skipping pytest. This is expected for now."


